tinymce.PluginManager.add('imgupload', function (editor, url) {
    function dialog() {
        editor.windowManager.open({
            title: 'Upload an image',
            file: url + '/upload.php',
            id: 'abc',
            name: 'abc',
            width: 350,
            height: 48,
            buttons: [{
                text: 'Upload',
                classes: 'widget btn primary first abs-layout-item',
                disabled: false,
                onclick: function (e) {
                    e.preventDefault();
                    var frame = $(e.currentTarget).find("iframe").get(0);
                    var content = frame.contentDocument;
                    var uploadForm = $(content).find("#upload_form");
                    var action = $(content).find("#upload-action").data('action');
                    if(action) {
                        uploadForm.ajaxSubmit({
                            url: action,
                            success: function(response) {
                                data = typeof response === 'string' ? JSON.parse(response) : response;
                                if (data.status && data.link) {
                                    tinymce.activeEditor.insertContent('<img src=' + data.link + ' />');
                                    notifySuccess(data.message);
                                } else {
                                    notifyError(data.message);
                                }
                                top.tinymce.activeEditor.windowManager.close();
                            },
                            error: function(error) {
                                notifyError('Upload Failed');
                            }
                        })
                    } else {
                        uploadForm.submit();
                    }
                }
            }, {text: 'Close', onclick: 'close'}]
        })
    }

    editor.addButton('imgupload', {tooltip: 'Upload an image', text: 'Upload Image', onclick: dialog});
    editor.addMenuItem('imgupload', {text: 'Upload image', context: 'insert', onclick: dialog})
});